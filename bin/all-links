#!/bin/bash

# Get all links from any running browsers.
# Supports Safari, Firefox, and Chrome.
#
# Requirements:
# * ripgrep (brew install ripgrep)
# * chrome-cli (brew install chrome-cli)
# * https://github.com/gabebw/rust-firefox-all-open-urls

set -e

is_running(){
  ps x | rg -v rg | rg -q "$1"
}

all-safari-links(){
  # Only check for Safari links if Safari is running, because the Applescript
  # will open Safari and we don't want do do that if Safari isn't already
  # running.
  if is_running /Applications/Safari.app; then
    osascript -l JavaScript <<EOL
      app = Application('Safari');
      tabs = [];
      for(var i = 0; i < app.windows.length; i++){
        window = app.windows[i];
        for(var j = 0; j < window.tabs.length; j++){
          tab = window.tabs[j];
          tabs.push(tab.url());
        }
      }
      // console.log prints to STDERR, so just return a string, which goes to
      // STDOUT
      tabs.join("\n")
EOL
  fi
}

all-chrome-links(){
  if is_running 'Google Chrome$'; then
    chrome-cli list links | sed -E 's/^.+ (.+)/\1/' | rg -v '^view-source:'
  fi
}

all-firefox-links(){
  if is_running Firefox.app; then
    firefox-open-urls-parser
  fi
}

(all-safari-links; all-chrome-links; all-firefox-links) | sort -u
