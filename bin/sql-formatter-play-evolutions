#!/usr/bin/env bash

# Format Play Framework evolutions, preserving blank lines around headers.
# Thanks to @devinjameson!

set -euo pipefail

sql_buffer=''
first_header_printed=false

format_and_print_sql() {
  if [[ -n $sql_buffer ]]; then
    printf '%s' "$sql_buffer" | sql-formatter -l postgresql
    sql_buffer=''
  fi
}

process_header_line() {
  format_and_print_sql

  if $first_header_printed; then
    printf '\n'  # blank line before subsequent headers
  fi
  first_header_printed=true

  printf '%s\n\n' "$line"  # header + trailing blank line
}

while IFS='' read -r line || [[ -n $line ]]; do  # handle final NL-less line
  if [[ $line == \#\ ---* ]]; then
    process_header_line
  else
    sql_buffer+="$line"$'\n'
  fi
done

format_and_print_sql  # format the remaining SQL (Downs section)
