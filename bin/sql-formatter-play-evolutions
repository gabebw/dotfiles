#!/usr/bin/env fish

# Format Play Framework evolutions, preserving blank lines after the "Ups"/"Downs" headers for each section.
# It uses `sql-formatter`:
# * Playground: https://sql-formatter-org.github.io/sql-formatter/
# * Docs: https://github.com/sql-formatter-org/sql-formatter?tab=readme-ov-file#sql-formatter---
# Thanks to @devinjameson!

# Read everything piped into this command into one big hunk of text in the $sql variable
set sql ''
while read x
  set sql $sql\n$x
end

# The `sed` line adds a newline after these lines:
#     # --- !Ups
#     # --- !Downs
# With `--language postgresql`, sql-formatter knows that `#` means "comment".
printf $sql | \
  sql-formatter --language postgresql | \
  sed -E 's/# --- !(Ups|Downs)/&\n/'
